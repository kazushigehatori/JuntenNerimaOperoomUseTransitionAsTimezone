# 時間帯別稼働推移 — 計算集計方法とグラフ表示シート作成手順

バージョン: 4.0 ｜ 最終更新: 2026年2月 ｜ 対象: 手術室管理部門

---

## 目次

- [第1部：計算集計方法](#第1部計算集計方法)
  - [1.1 ツール概要](#11-ツール概要)
  - [1.2 入力データ仕様](#12-入力データ仕様)
  - [1.3 集計対象の定義](#13-集計対象の定義)
  - [1.4 1分サンプリング＋30分平均方式による計数方法](#14-1分サンプリング30分平均方式による計数方法)
  - [1.5 曜日別集計](#15-曜日別集計)
  - [1.6 計算例](#16-計算例)
  - [1.7 出力仕様](#17-出力仕様)
- [第2部：グラフ表示シート作成手順](#第2部グラフ表示シート作成手順)
  - [2.1 作成の考え方](#21-作成の考え方)
  - [2.2 作成手順（Step 1〜9）](#22-作成手順step-19)
  - [2.3 動作確認](#23-動作確認)

---

## 第1部：計算集計方法

### 1.1 ツール概要

本ツールは、手術実施データから「時間帯ごとに平均何室の手術室が稼働しているか」を集計します。8:00〜20:00の間、30分おきに25個のスナップショット時刻を設定し、各スナップショット時刻から30分間（+0分〜+29分）を1分毎にサンプリングして使用中の手術室数を計測します。30個の1分サンプルの平均値を当該スナップショットの値とし、月間の日平均を算出します。また、曜日別（月・火・水・木・金・土）の集計も同時に行い、各曜日の稼働推移を個別に把握できます。

| 項目 | 内容 |
|---|---|
| アプリケーション | `時間帯別稼働推移.exe`（ダブルクリックで実行） |
| 入力ファイル | `時間帯別稼働推移元データ.xlsx` |
| 出力ファイル | `時間帯別稼働推移-結果.xlsx` |
| 動作環境 | Windows 10 / 11（Python不要） |

### 1.2 入力データ仕様

**シート「時間帯別稼働推移元データ」のカラム：**

| カラム名 | 型 | 説明 | 例 |
|---|---|---|---|
| 手術実施管理番号 | 文字列/数値 | 一意の管理番号 | 1000104765 |
| 手術実施日 | 文字列 | YYYY/MM/DD形式 | 2025/09/01 |
| 曜日 | 文字列 | ○曜日 形式 | 月曜日 |
| 実施手術室名 | 文字列 | 手術室番号 | 01A, 09, 10 |
| 入室時刻 | 時刻 | HH:MM:SS形式 | 08:44:00 |
| 麻酔終了時刻 | 時刻 | HH:MM:SS形式 | 13:39:00 |
| 実施申込区分 | 文字列 | 定時 / 臨時 / 緊急 | 定時 |

### 1.3 集計対象の定義

**対象手術室とウェイト：**

| 手術室 | ウェイト | 備考 |
|---|---|---|
| 01A | 1.0 | 01Bの使用も01Aとしてカウント |
| 01B | 0（統合対象） | 01Bの手術データは01Aに統合される |
| 02, 03, 05, 06, 07, 08, 09, 10 | 各1.0 | 標準手術室 |

> ウェイト0の部屋（01B）の手術データは、同一番号系列のウェイト>0の部屋（01A）に自動統合されます。合計9室（01A, 02, 03, 05, 06, 07, 08, 09, 10）、ウェイト合計 9.0。

> ｱﾝｷﾞｵは本ツールの対象外です（入力データに含まれていても無視されます）。

**除外曜日：**

| 除外対象 | 理由 |
|---|---|
| 土曜日 | 定時帯と稼働パターンが異なるため |
| 日曜日 | 原則手術なし |

**集計区分（2パターン）：**

| 区分名 | 対象となる実施申込区分 | 出力先 |
|---|---|---|
| 全手術（緊急含む） | 定時・臨時・緊急 | 計算結果シート Row2（B2:Z2） |
| 予定手術のみ | 定時 のみ | 計算結果シート Row3（B3:Z3） |

**曜日集計の定義（Row19-20）：**

| 行 | 内容 |
|---|---|
| Row19 | 曜日集計（土曜日） |
| Row20 | 土曜日の稼働を計算 |

> この定義により、曜日別集計では土曜日も計算対象に含まれます。

### 1.4 1分サンプリング＋30分平均方式による計数方法

#### サンプリングの定義

各スナップショット時刻に対して、30分間の集計区間を設定し、1分毎にサンプリングする。

| 項目 | 定義 |
|---|---|
| サンプリング間隔 | 1分毎 |
| 集計区間の開始 | スナップショット時刻 + 0分 |
| 集計区間の終了 | スナップショット時刻 + 29分 |
| 集計区間の長さ | 30分間（30個の1分サンプル） |
| 全体のサンプリング範囲 | 8:00〜20:29（750分） |

**集計区間の一覧（全25区間）：**

| スナップショット時刻 | 集計区間 |
|---|---|
| 8:00 | 8:00〜8:29 |
| 8:30 | 8:30〜8:59 |
| 9:00 | 9:00〜9:29 |
| 9:30 | 9:30〜9:59 |
| 10:00 | 10:00〜10:29 |
| 10:30 | 10:30〜10:59 |
| 11:00 | 11:00〜11:29 |
| 11:30 | 11:30〜11:59 |
| 12:00 | 12:00〜12:29 |
| 12:30 | 12:30〜12:59 |
| 13:00 | 13:00〜13:29 |
| 13:30 | 13:30〜13:59 |
| 14:00 | 14:00〜14:29 |
| 14:30 | 14:30〜14:59 |
| 15:00 | 15:00〜15:29 |
| 15:30 | 15:30〜15:59 |
| 16:00 | 16:00〜16:29 |
| 16:30 | 16:30〜16:59 |
| 17:00 | 17:00〜17:29 |
| 17:30 | 17:30〜17:59 |
| 18:00 | 18:00〜18:29 |
| 18:30 | 18:30〜18:59 |
| 19:00 | 19:00〜19:29 |
| 19:30 | 19:30〜19:59 |
| 20:00 | 20:00〜20:29 |

#### 使用中判定ルール

各1分サンプル時刻において、手術室が使用中かどうかを判定する。

判定条件：**入室時刻 ≦ サンプル時刻 ≦ 麻酔終了時刻** のとき「使用中」。

| 判定 | 条件 |
|---|---|
| 使用中と判定 | 入室時刻 ≦ サンプル時刻 ≦ 麻酔終了時刻 |
| カウント値 | 使用中の場合、当該手術室のウェイト値（全室1.0） |
| 部屋ごとの上限 | 同一部屋で複数件の手術が同じ分にかかっても、使用数は **1.0**（上限あり） |
| スナップショット値 | 集計区間内の30個の1分サンプルの使用室数合計 ÷ 30 = 平均使用室数 |
| 集計方法 | 対象日ごとにスナップショット値を算出し、全対象日の合計 ÷ 対象日数 で日平均を算出 |
| 丸め | 小数第2位まで（例：6.55） |

> **各時刻の値 = Σ（全対象日の当該時刻の30分平均使用室数）÷ 対象日数**

#### 01B→01A統合ロジック

> 定義シートで01Bのウェイトが0に設定されている場合、元データ上で部屋=01Bの手術レコードは、すべて部屋=01Aとして扱われます。これにより、01Aと01Bは物理的に1室（01A）として集計されます。同一時刻に01Aと01Bの両方で手術が行われていても、01Aとして1.0のみカウントされます。

#### 部屋ごとのカウント上限

> 同一部屋で手術の入れ替わり（前の手術が終了し、次の手術が開始）が同じ分に起きた場合、両方の手術が判定にヒットする可能性がある。この場合でも、部屋ごとに **1.0が上限** となる。
>
> 例：05号室で手術A（〜14:05終了）→ 手術B（14:05入室〜）の場合、14:05のサンプルでは両方がヒットするが、05号室としては 1.0 のみ。

### 1.5 曜日別集計

全体集計（Row2-3）に加え、月曜日〜土曜日の各曜日ごとに同じ1分サンプリング＋30分平均方式で集計を行います。

**全体集計と曜日別集計の違い：**

| 項目 | 全体集計（Row2-3） | 曜日別集計（Row7以降） |
|---|---|---|
| 対象データ | 土日を除外した全平日 | 各曜日のデータのみ |
| 除外曜日 | 定義シートの除外設定に従う（土曜日・日曜日） | 適用しない（土曜日も計算対象） |
| 計数ロジック | 同一 | 同一 |
| 出力 | Row2:全手術、Row3:予定のみ | 曜日ごとに全手術・予定のみの2行 |

**対象曜日と出力先：**

| 曜日 | 全手術の出力行 | 予定手術の出力行 |
|---|---|---|
| 月曜日 | B7:Z7 | B8:Z8 |
| 火曜日 | B12:Z12 | B13:Z13 |
| 水曜日 | B17:Z17 | B18:Z18 |
| 木曜日 | B22:Z22 | B23:Z23 |
| 金曜日 | B27:Z27 | B28:Z28 |
| 土曜日 | B32:Z32 | B33:Z33 |

> **注：** 曜日テーブルの並び順は月→火→水→木→金→土です（計算結果シートのレイアウトに準拠）。日曜日は原則手術なしのため集計対象外です。

**土曜日の集計について：**

> 定義シートのRow19-20に「曜日集計（土曜日）：土曜日の稼働を計算」が定義されています。全体集計では除外される土曜日も、曜日別集計では計算対象となります。

### 1.6 計算例

> **例1：2025/09/01（月曜日）、スナップショット時刻 = 9:00（集計区間 9:00〜9:29）**
>
> この集計区間内の各1分について使用室数をカウントし、30個の平均を取る：
> - 09号室：入室 8:44 〜 麻酔終了 13:39 → 9:00〜9:29の全30分で使用中（1.0 × 30 = 30.0）
> - 06号室：入室 9:07 〜 麻酔終了 10:24 → 9:07〜9:29の23分で使用中（1.0 × 23 = 23.0）
> - 10号室：入室 8:41 〜 麻酔終了 15:08 → 9:00〜9:29の全30分で使用中（1.0 × 30 = 30.0）
> - 08号室：入室 9:03 〜 麻酔終了 13:01 → 9:03〜9:29の27分で使用中（1.0 × 27 = 27.0）
> - 05号室：入室 9:07 〜 麻酔終了 12:23 → 9:07〜9:29の23分で使用中（1.0 × 23 = 23.0）
> - 02号室：入室 9:03 〜 麻酔終了 10:42 → 9:03〜9:29の27分で使用中（1.0 × 27 = 27.0）
> - 03号室：入室 9:06 〜 麻酔終了 9:32 → 9:06〜9:29の24分で使用中（1.0 × 24 = 24.0）
> - 01A号室：入室 14:13 〜 麻酔終了 15:50 → 9:00〜9:29では未使用（0分）
>
> 各分の使用室数合計 = 184.0 ÷ 30 = **6.13室**（30分平均）

### 1.7 出力仕様

**全体集計「計算結果」シートのレイアウト（Row1-3）：**

| | A列 | B列 | C列 | D列 | … | Z列 |
|---|---|---|---|---|---|---|
| Row1 | 集計結果 | 8:00 | 8:30 | 9:00 | … | 20:00 |
| Row2 | 全手術（緊急含む） | 0.0 | 1.17 | 5.97 | … | 0.02 |
| Row3 | 予定手術のみ | 0.0 | 1.06 | 5.56 | … | 0.01 |

> Row1（ヘッダ）とA2:A3（行ラベル）は元ファイルに事前設定済み。exeが書き込むのは **B2:Z3の数値（50セル）のみ** です。

**曜日別集計のレイアウト（Row5〜33）：**

各曜日テーブルは以下の構造で繰り返されます（例：月曜日）：

| 行 | A列 | B列〜Z列 |
|---|---|---|
| Row5 | 月曜日（曜日ラベル） | |
| Row6 | 集計結果（ヘッダ） | 8:00〜20:00 |
| Row7 | 全手術（緊急含む） | exe実行時に書き込み |
| Row8 | 予定手術のみ | exe実行時に書き込み |
| Row9 | （空行） | |

同様に火曜日（Row10-14）、水曜日（Row15-19）、木曜日（Row20-24）、金曜日（Row25-29）、土曜日（Row30-33）が続きます。

> 曜日ラベル行、ヘッダ行、行ラベルは元ファイルに事前設定済み。exeが書き込むのは各曜日の値エリア（全手術行と予定手術行のB〜Z列）のみです。

---

## 第2部：グラフ表示シート作成手順

### 2.1 作成の考え方

元ファイルに「グラフ表示」シートを追加し、計算結果シートのB2:Z3を参照するグラフをExcelの機能で作成します。一度作成すれば、以降はexe実行のたびにグラフが自動更新されます。

> **なぜExcelでグラフを作るのか：**
> openpyxl（Pythonライブラリ）で面グラフを作成すると、垂直グリッド線の位置がカテゴリラベルの間に入ってしまう制約があります。Excelの「日付軸」設定を使えばグリッド線をラベル位置に正確に配置できるため、グラフはExcelで事前作成する方式を採用しました。

### 2.2 作成手順（Step 1〜9）

#### Step 1：シート追加

元ファイル（`時間帯別稼働推移元データ.xlsx`）をExcelで開きます。シートタブを右クリック →「挿入」→ ワークシートを追加し、シート名を `グラフ表示` に変更します。

#### Step 2：グラフ挿入

「グラフ表示」シートを選択した状態で：
「挿入」タブ →「グラフ」→「面」→「**2-D 面**」を選択します。空のグラフが挿入されます。

#### Step 3：データ系列1 — 全手術（面グラフ）

グラフを右クリック →「**データの選択**」→「追加」：

| 項目 | 入力値 |
|---|---|
| 系列名 | `=計算結果!$A$2` |
| 系列値 | `=計算結果!$B$2:$Z$2` |

「OK」をクリック。次に「横（項目）軸ラベル」の「**編集**」をクリック：

| 項目 | 入力値 |
|---|---|
| 軸ラベルの範囲 | `=計算結果!$B$1:$Z$1` |

「OK」→「OK」

#### Step 4：データ系列2 — 予定手術のみ（追加して折れ線に変更）

グラフを右クリック →「データの選択」→「追加」：

| 項目 | 入力値 |
|---|---|
| 系列名 | `=計算結果!$A$3` |
| 系列値 | `=計算結果!$B$3:$Z$3` |

「OK」→「OK」で閉じます。

次にグラフ内の「**予定手術のみ**」の面部分をクリック → 右クリック →「**系列グラフの種類の変更**」→ 「予定手術のみ」を「**折れ線**」に変更 →「OK」

#### Step 5：色・書式の設定

**■ 全手術（面グラフ）：**
面部分をクリック → 右クリック →「データ系列の書式設定」

| 設定項目 | 値 |
|---|---|
| 塗りつぶし色 | 水色 #BDD7EE |
| 透明度 | 30〜40%（グリッド線が透けて見える程度） |
| 枠線 | なし |

**■ 予定手術のみ（折れ線）：**
線をクリック → 右クリック →「データ系列の書式設定」

| 設定項目 | 値 |
|---|---|
| 線の色 | 濃い青 #2E75B6 |
| 線の幅 | 2pt |
| スムージング | チェックを入れる |

#### Step 6：縦軸（Y軸）の設定

縦軸の数値をダブルクリック →「軸の書式設定」

| 設定項目 | 値 |
|---|---|
| 最小値 | 0 |
| 最大値 | 9 |
| 目盛間隔（主） | 1 |

軸タイトルを追加：「**（部屋数）**」

#### Step 7：横軸（X軸）の設定 ★重要

横軸のラベルをダブルクリック →「軸の書式設定」

| 設定項目 | 値 |
|---|---|
| 軸の種類 | **「日付軸」に変更**（これで垂直グリッド線がラベル位置に揃います） |
| 目盛の間隔 | 1 |

> **ポイント：**「テキスト軸」のままだと垂直グリッド線がラベルの間に入ります。必ず「**日付軸**」に変更してください。

#### Step 8：グリッド線の設定

グラフ内をクリック → 右上の「＋」ボタン（グラフ要素）→「目盛線」

| 設定項目 | 操作 |
|---|---|
| 水平グリッド線 | 「第1主横軸目盛線」にチェック |
| 垂直グリッド線 | 「第1主縦軸目盛線」にチェック |
| グリッド線の色 | 各グリッド線をクリック → 薄いグレーに変更 |

#### Step 9：凡例・仕上げ・保存

凡例はグラフ上部に配置。グラフタイトルは削除または「＜申込区分別＞」等に設定。グラフサイズを適宜調整します。

完了したら元ファイル（`時間帯別稼働推移元データ.xlsx`）を **上書き保存** します。

### 2.3 動作確認

> **確認方法：**
> exe を実行して「時間帯別稼働推移-結果.xlsx」を開き、「グラフ表示」シートにグラフが正しく表示されることを確認してください。計算結果シートのB2:Z3に値が書き込まれ、グラフが自動で反映されます。

> **注意事項：**
> - 「グラフ表示」シートの名前は変更しないでください
> - 「計算結果」シートのB1:Z1（時刻ヘッダ）やA2:A3（行ラベル）は変更しないでください
> - exeは「計算結果」シートのB2:Z3および曜日別集計エリア（Row7〜33の値行）に値を書き込みます。「グラフ表示」シートには一切触れないため、一度グラフを作成すれば毎月のデータ更新はexe実行だけで完了します

---

*時間帯別稼働推移 — 計算集計方法とグラフ表示シート作成手順 v4.0 (c) 2025*
